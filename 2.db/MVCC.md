# MVCC (Multi-Version Concurrency Control) в PostgreSQL

## 1. Что такое MVCC

**MVCC** — это механизм многоверсионного управления конкурентным доступом.  
Вместо блокировок на чтение PostgreSQL создаёт несколько версий одной и той же строки (tuple) при изменениях, позволяя:

- **Чтениям** происходить без блокировки записей.
- **Записям** не блокировать другие читающие транзакции.

То есть читатели видят «снимок» данных на момент начала своей транзакции, а писатели работают с новыми версиями строк, не мешая друг другу.

---

## 2. Как это реализовано

В PostgreSQL каждая строка (tuple) в таблице хранит специальные системные поля:

- `xmin` — ID транзакции, которая создала запись.
- `xmax` — ID транзакции, которая «удалила» (или обновила) запись.

При **UPDATE** PostgreSQL:

- Не изменяет строку на месте.
- Создаёт новую версию строки с новым `xmin` (ID текущей транзакции).
- Ставит в старую версию `xmax` — ID текущей транзакции (она считается «неактуальной»).

Таким образом, каждая версия строки знает, кем и когда она была создана и кем «удалена».

---

## 3. Видимость версий

Когда транзакция выполняет `SELECT`, PostgreSQL решает, какая версия строки ей «видна».  
Для этого проверяются:

- ID текущей транзакции.
- `xmin` и `xmax` каждой версии строки.
- Состояние транзакций в `pg_xact` (таблица системного каталога, где хранится статус транзакций: committed, aborted, in progress).

**Правило:** транзакция видит только те версии строк, которые были зафиксированы до начала этой транзакции и не удалены к этому моменту.

---

## 4. Пример жизненного цикла строки

| Операция | xmin | xmax | Что видят другие |
|----------|------|------|------------------|
| `INSERT T1` | T1 | null | Другие транзакции не видят пока T1 не закоммитит. |
| `UPDATE T2` | T2 | null | Старая версия получает `xmax=T2`, новая версия — `xmin=T2`. |
| `DELETE T3` | T3 | null | Строка получает `xmax=T3`. Для читающих до T3 она видна, после — нет. |

---

## 5. VACUUM и «сбор мусора»

Поскольку старые версии строк остаются в таблице, их нужно периодически очищать.  
Этим занимается процесс **VACUUM**:

- Находит версии строк, которые больше никому не видны.
- Физически удаляет их (освобождает место).

Есть ещё **autovacuum**, который запускается автоматически.

---

## 6. Преимущества MVCC

- **Низкий уровень блокировок:** `SELECT` не блокирует `UPDATE/INSERT/DELETE`.
- **Предсказуемость чтения:** каждый запрос видит согласованное состояние данных.
- **Высокая производительность** при большом числе читающих транзакций.

---

## 7. Недостатки

- Требуется больше места на диске (старые версии строк до VACUUM).
- `VACUUM` и `autovacuum` — важная часть эксплуатации (иначе таблицы «раздуваются»).
- Возможны проблемы с **wraparound** (переполнение ID транзакций), если не следить.

---

## 8. Сравнение с блокировками

| Подход                  | Чтение               | Запись                |
|-------------------------|----------------------|-----------------------|
| Классические блокировки | Блокируют друг друга | Блокируют             |
| MVCC                    | Чтение без блокировок| Новая версия строки   |
