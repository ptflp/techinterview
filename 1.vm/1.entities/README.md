# Полный поток трансляции виртуального адреса

Здесь разберём весь путь виртуального адреса от программы до физической памяти, включая все ключевые сущности.

---

## 1. Virtual Address (VA)

Программа оперирует виртуальными адресами. Адрес делится на:

* **VPN (Virtual Page Number)** — номер виртуальной страницы.
* **Page offset** — смещение внутри страницы.

Пример (x86-64, 48-битная адресация, страницы 4 KiB):

```
[ 9 бит | 9 бит | 9 бит | 9 бит | 12 бит ]
   PML4   PDPT     PD      PT     Offset
```

---

## 2. Context PID (Process Context ID)

* В многоадресных ОС у каждого процесса своё виртуальное пространство.
* Для отличия записей TLB используется **PCID (Process Context Identifier)** — аналог PID для MMU.
* Это позволяет не сбрасывать TLB при каждом `context switch`.

```
VA + PCID → TLB
```

---

## 3. Translation Lookaside Buffer (TLB)

Кэш трансляций VPN → PPN.

```
             +-------------------+
VA+PCID ---> |       TLB         |--- HIT --> PPN
             +-------------------+--- MISS --> Page Table Walk
```

* **TLB hit** → быстрый доступ к PPN.
* **TLB miss** → выполняется обход таблицы страниц.

---

## 4. Page Table Walk

При TLB miss происходит обход таблиц страниц. В x86-64 используется 4-уровневая структура:

```
CR3 → PML4 → PDPT → PD → PT → PTE → PPN
```

* **CR3** хранит физический адрес PML4 для текущего процесса.
* Каждый уровень индексируется своей частью VPN.
* В конце получаем **Page Table Entry (PTE)**.

---

## 5. Page Table Entry (PTE)

PTE содержит:

* **PPN (Physical Page Number)** — номер физической страницы.
* **Флаги доступа**:

    * P (Present)
    * R/W (Read/Write)
    * U/S (User/Supervisor)
    * NX (No Execute)
    * A (Accessed)
    * D (Dirty)
    * G (Global)

```
64-бит PTE:
+----------------------------------------------+----------------+
|         PPN (Physical Page Number)           |     Flags       |
+----------------------------------------------+----------------+
```

---

## 6. Проверка PTE

1. **P=1** → страница присутствует в RAM.
2. **P=0** → возникает Page Fault.

    * ОС проверяет swap.
    * Если страница там → загружает в RAM.
    * Если нет → Segmentation Fault.

---

## 7. Формирование Physical Address (PA)

```
Physical Address = PPN + Page Offset
```

Теперь можно обратиться к данным в RAM.

---

## 8. Итоговый поток

```
Программа → Virtual Address (VA)
             + PCID (Context PID)
                    |
                    v
                [TLB lookup]
                |         \
             HIT            MISS
              |              |
              v              v
            PPN        Page Table Walk
                           |
                         PTE check
                         |      \
                      Present?   Fault
                         |          |
                         v          v
                   PPN + offset   Swap/Disk
                         |
                         v
                  Physical Address (PA)
                         |
                         v
                        RAM
```

---

## Кратко

* **VA**: виртуальный адрес.
* **PCID**: ID процесса в контексте памяти.
* **TLB**: быстрый кэш трансляций.
* **Page Table Walk**: обход таблицы страниц через CR3.
* **PTE**: запись с PPN и флагами.
* **PPN + offset = PA**: формируется физический адрес.
* **Page Fault**: подгрузка страницы из swap или ошибка.

Таким образом, виртуальная память обеспечивает полную изоляцию процессов и гибкость управления памятью за счёт многоуровневого преобразования адресов.
